# Решение для хранения фото сотрудников

## Проблема

`file_id` от Telegram Bot API **временный** (обычно действует несколько дней/недель) и **не подходит** для долгосрочного хранения на полгода. Для статистики нужно хранить фото самостоятельно.

## Решение

### Вариант 1: Локальное хранилище (простой, для начала)

Хранить фото на сервере в папке `uploads/photos/` и сохранять путь в БД.

**Плюсы:**
- Просто реализовать
- Не требует внешних сервисов
- Бесплатно

**Минусы:**
- Требует места на диске
- Нужно настроить бэкапы
- Не масштабируется для больших объемов

### Вариант 2: Облачное хранилище (рекомендуется для продакшена)

Использовать S3-совместимое хранилище (Railway Volumes, AWS S3, Cloudflare R2 и т.д.)

**Плюсы:**
- Масштабируемо
- Надежно
- Легко настроить бэкапы
- CDN для быстрой загрузки

**Минусы:**
- Требует настройки внешнего сервиса
- Может быть платно при больших объемах

## Реализация

### 1. Обновлена схема БД ✅

Добавлены поля в `CheckInResult`:
- `photoFileId` - временный file_id от Telegram (для совместимости)
- `photoUrl` - URL сохраненного фото (для долгосрочного хранения)
- `photoPath` - путь к файлу на сервере (если храним локально)

### 2. Endpoint для загрузки фото

Нужно восстановить `server/index.js` из коммита `389c2cc9a14d29d570d9cd0aa6a597123ac6db5e` и добавить:

```javascript
// Используем multer для обработки multipart/form-data
const upload = multer({ 
  dest: 'uploads/photos/',
  limits: { fileSize: 10 * 1024 * 1024 }, // 10MB максимум
  fileFilter: (req, file, cb) => {
    if (file.mimetype.startsWith('image/')) {
      cb(null, true);
    } else {
      cb(new Error('Только изображения разрешены'));
    }
  }
});

app.post('/api/check-in/photo', 
  verifyTelegramWebApp,
  upload.single('photo'),
  async (req, res) => {
    // Реализация согласно документу
  }
);
```

### 3. Очистка старых фото (cron job)

Добавить cron job для автоматической очистки фото старше 6 месяцев.

## Необходимые изменения

1. ✅ Обновлена схема БД
2. ✅ Исправлен CheckInInterface для правильного вызова камеры
3. ⏳ **Восстановить `server/index.js` из коммита `389c2cc9a14d29d570d9cd0aa6a597123ac6db5e`**
4. ⏳ Добавить multer middleware и реализовать загрузку фото
5. ⏳ Добавить endpoint для получения фото
6. ⏳ Добавить cron job для очистки старых фото

## Для Railway

Railway предоставляет постоянное хранилище через Volumes. Можно настроить volume для папки `uploads/`:

1. В Railway Dashboard: Settings > Volumes
2. Добавить volume для `/app/uploads`
3. Фото будут сохраняться между деплоями
